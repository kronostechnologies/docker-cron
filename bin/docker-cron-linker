#!/bin/bash

set -e

function log {
  echo "cronlinker: $@"
}

if [ ! -z "${CRONLINKER_FILE}" ] && [ -f "${CRONLINKER_FILE}" ]
then
  log "CRONLINKER_FILE: defined as ${CRONLINKER_FILE}"
else
  if [ -z "${CRONLINKER_PATH}" ];
  then
    log "CRONLINKER_PATH: undefined variable, using default (/jobs)"
  else
    log "CRONLINKER_PATH: defined as ${CRONLINKER_PATH}"
  fi
  CRONLINKER_PATH="${CRONLINKER_PATH:-/jobs}"

  if [ -z "${CRONLINKER_ENVIRONMENT}" ]
  then
    log "CRONLINKER_ENVIRONMENT: undefined variable"
  else
    log "CRONLINKER_ENVIRONMENT: defined as ${CRONLINKER_ENVIRONMENT}"
  fi

  if [ -z "${CRONLINKER_SITE}" ]
  then
    log "CRONLINKER_SITE: undefined variable"
  else
    log "CRONLINKER_SITE: defined as ${CRONLINKER_SITE}"
  fi

  cronfile="${CRONLINKER_PATH}/${CRONLINKER_ENVIRONMENT}/${CRONLINKER_SITE}"
  if [ -f $cronfile ];
  then
    log "CRONLINKER_FILE: defined as '$cronfile'"
    CRONLINKER_FILE="${CRONLINKER_FILE:-$cronfile}"
  else
    log "CRONLINKER_FILE: not found '${cronfile}'"
  fi
fi

if [ ! -z "${CRONLINKER_FILE}" ]
then
  log "success: linked '${CRONLINKER_FILE}' to /etc/cron.d/jobs"
  ln -s "${CRONLINKER_FILE}" /etc/cron.d/jobs
else
  log "warning: not linking any cronjob to /etc/cron.d/jobs"
fi
